#!/bin/sh

# Install binaries via Cabal in an isolated environment.



###############################################################################
##  Check for correct invocation  #############################################
###############################################################################

self="$(basename "$0")"
if [ $# -eq 0 ]
then
      printf "Usage: %s (package)+\n" "$self" >&2
      exit 1
fi



###############################################################################
##  Create temporary directory  ###############################################
###############################################################################

printf "Creating temporary directory"
tmp="$(mktemp -d 2>/dev/null || mktemp -d -t cabal)"
printf " (%s)\n" "$tmp"
cd "$tmp"



###############################################################################
##  Get prefix  ###############################################################
###############################################################################

prefix="$HOME/.cabal/"



###############################################################################
##  Run Cabal  ################################################################
###############################################################################

{
      cabal sandbox init \
      &&
      cabal install --disable-documentation \
                    --disable-library-profiling \
                    --disable-shared \
                    --disable-executable-dynamic \
                    --prefix="$prefix" \
                    "$@"
} || {
      printf "%s %s: Installation failed!\n" "$self" "$@" >&2
}



###############################################################################
##  Delete temporary directory  ###############################################
###############################################################################

printf "Remove temporary directory (%s) [Y/n]? " "$tmp"
read deleteTemp
if [ "$deleteTemp" != "n" ]
then
      rm -r "$tmp"
fi
